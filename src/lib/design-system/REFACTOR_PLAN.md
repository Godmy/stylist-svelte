# Архитектурная Программа Рефакторинга Design System

## 1) Контекст и Факты (на основе текущего кода)

### 1.1 Масштаб
- Область: `stylist-svelte/src/lib/design-system`
- Общее количество TS-файлов в design-system: 
  - `styles`: 169
  - `props`: 147
  - `models`: 117
  - `classes`: 40
  - `state`: 29
  - `tokens`: 21
  - `themes`: 5
  - `factory`: 5
  - `utils`: 4

### 1.2 Потребление из компонентов
- Файлов компонентов с импортами из design-system: `693`
- Все 693 файла используют deep-imports (`$stylist/design-system/...`)
- Использование корневого barrel (`$stylist/design-system`) внутри `src/lib`: `0`
- Наиболее нагруженные точки:
  - `$stylist/design-system/tokens/controls`: 348
  - `$stylist/design-system/playground`: 217
  - `$stylist/design-system/playground/Story.svelte`: 136
  - `$stylist/design-system/props`: 123
  - `$stylist/design-system/styles`: 59

### 1.3 Текущие архитектурные нарушения
- Коллизии публичных символов в barrel-экспортах.
- Взаимные зависимости слоев, которые должны быть однонаправленными:
  - `classes -> props` (4)
  - `props -> classes` (2)
- Высокая связанность runtime-слоев:
  - `models -> props` (81)
  - `models -> styles` (55)
  - `models -> state` (35)
  - `styles -> props` (32)
- Плоская структура тяжелых доменов (`props`, `styles`, `models`) без поддоменов.

## 2) Целевая Архитектура

### 2.1 Целевой принцип
Design-system становится платформенным слоем с:
1. Жесткими границами слоев.
2. Доменной модульностью.
3. Стабильным API-контрактом и версионированием.
4. Предсказуемой эволюцией через ADR и архитектурные проверки.

### 2.2 Целевая модель слоев
1. `tokens` — атомарные значения и типы токенов.
2. `themes` — композиция токенов и runtime theme-context.
3. `classes` — декларативные class maps (без runtime-логики).
4. `styles` — style-композиция на основе `classes + tokens (+ state defaults при необходимости)`.
5. `state` — вычисление состояния и атрибутов компонента.
6. `props` — публичные типовые контракты компонентов.
7. `models` — адаптеры/компоновщики для Svelte runes и совместимости.
8. `factory` — фабрики пресетов и архитектурных шаблонов.
9. `utils` — кросс-доменные утилиты.

### 2.3 Разрешенные зависимости (матрица правил)
- `tokens`: ни от кого
- `themes`: только `tokens`
- `classes`: только `tokens`
- `styles`: `classes`, `tokens`, ограниченно `state` (только defaults/presets)
- `state`: `tokens`, `classes`
- `props`: `tokens` (и типы html/svelte)
- `models`: `props`, `state`, `styles`, `utils`
- `factory`: `state`, `tokens`, `classes`
- `utils`: изолировано, без знания доменной бизнес-структуры

Запрещаемые связи (ключевые):
- `classes <-> props`
- `styles -> props` (кроме строго type-only на этапе перехода)
- `tokens -> любой верхний слой`

## 3) Целевая Доменная Декомпозиция

В `props`, `styles`, `models`, `state`, `classes` вводится одинаковая доменная сетка:
- `interaction`
- `information`
- `architecture`
- `feedback`
- `data-display`
- `shared`

Пример целевого пути:
- `design-system/props/interaction/forms/...`
- `design-system/styles/information/cards/...`
- `design-system/models/architecture/layout/...`

## 4) Архитектурные Результаты (Definition of Done программы)

1. Нет коллизий экспортируемых символов в публичных barrel-файлах.
2. Нет запрещенных межслойных зависимостей.
3. Не менее 80% модулей `props/styles/models` разложены по доменам.
4. Все импорты внутри `src/lib/components` мигрированы на утвержденные API-пути (без legacy-path).
5. Есть архитектурные проверки в CI: 
   - duplicate exports
   - forbidden import rules
   - circular dependencies
6. Документация отражает реальную архитектуру (без расхождений по количеству/составу файлов).

## 5) Программа По Волнам (архитектурные фазы)

## Волна A — Архитектурная Стабилизация (без переносов)

### Цель
Убрать архитектурные риски, не меняя массово структуру.

### Работы
1. Устранить дубли символов в `styles/index.ts` и `models/index.ts`.
2. Устранить дубли интерфейсов в `props`.
3. Ввести проверки: duplicate exports, круговые зависимости, forbidden imports.
4. Зафиксировать ADR-001: целевые слои и разрешенные зависимости.

### Артефакты
- ADR-001 Layering Rules
- Архитектурные проверки в пайплайне
- Нормализованные barrel-файлы без конфликтов

### Критерий завершения
Система «архитектурно безопасна» для начала миграции структуры.

## Волна B — Пилот Домена (Interaction)

### Цель
Проверить миграционный подход на самом нагруженном домене.

### Работы
1. Выделить поддомены `interaction` в `props/styles/models/state/classes`.
2. Перенести часть модулей по вертикальным срезам (тип -> стиль -> state -> model).
3. Сохранить compatibility re-exports только на переходный период.
4. Замерить impact: число обновленных импортов, количество ошибок, сложность review.

### Артефакты
- ADR-002 Domain Packaging Pattern
- Шаблон миграции «вертикальным срезом»
- Отчет по пилоту (время, риски, дефекты)

### Критерий завершения
Подтвержден повторяемый подход для остальных доменов.

## Волна C — Массовая Доменная Миграция

### Цель
Перевести оставшиеся домены на целевую архитектуру.

### Работы
1. Миграция доменов в порядке приоритета:
   1. `information`
   2. `feedback`
   3. `architecture`
   4. `data-display`
   5. `shared`
2. Унификация нейминга (`createXState`, `XProps`, `XStyleManager`).
3. Декомпозиция «толстых» файлов и удаление неоднозначных модулей.

### Артефакты
- Новый доменный layout в design-system
- Карта old->new import paths
- Временный compatibility layer

### Критерий завершения
Основная структура соответствует целевой доменной модели.

## Волна D — API Контракты и Публикация

### Цель
Стабилизировать внешние контракты и подготовить долговременную поддержку.

### Работы
1. Определить стабильные публичные entry points.
2. Разделить:
   - Public API (гарантированная совместимость)
   - Internal API (без гарантий для потребителей)
3. Подготовить migration guide для deep-import потребителей.
4. Ввести policy депрекации путей (минимум 1 релизный цикл).

### Артефакты
- ADR-003 Public API Surface
- Migration Guide v1
- Deprecation Matrix

### Критерий завершения
Публичные точки входа зафиксированы и документированы.

## Волна E — Очистка и Финализация

### Цель
Убрать временные слои и закрепить архитектурную дисциплину.

### Работы
1. Удалить legacy compatibility re-exports.
2. Удалить неиспользуемые/дублирующие модули.
3. Синхронизировать README/архитектурные документы с фактической структурой.
4. Провести финальный архитектурный аудит.

### Артефакты
- Финальная структура
- Отчет архитектурного аудита
- Закрытые ADR action items

### Критерий завершения
Нет технических «времянок» миграции, документация и код синхронизированы.

## 6) Управление Архитектурой (Governance)

### 6.1 ADR backlog (минимум)
1. ADR-001: Layering and Dependency Rules
2. ADR-002: Domain Packaging and Folder Strategy
3. ADR-003: Public API and Compatibility Policy
4. ADR-004: Naming Conventions (`Props/State/StyleManager`)
5. ADR-005: Token/Theme Source of Truth

### 6.2 Архитектурные проверки в CI
1. Запрет дублирующихся export-символов в barrel.
2. Запрет forbidden imports по слоям.
3. Проверка на циклические зависимости.
4. Проверка, что новые файлы в `props/styles/models` создаются в доменных подпапках.

## 7) KPI Программы

1. `Duplicate Export Count` -> 0.
2. `Forbidden Dependency Violations` -> 0.
3. `Share of Domain-structured files` -> >= 80%.
4. `Legacy path usage in src/lib/components` -> 0 к завершению Волны E.
5. `Architecture review lead time` (медиана) снижается минимум на 30%.

## 8) Риски и Меры Снижения

1. Риск: массовые переименования сломают импортные цепочки.
- Мера: совместимые re-exports + миграция волнами + авто-проверки.

2. Риск: деградация скорости команд из-за большой миграции.
- Мера: пилотный домен + шаблон миграции + четкий DoD на волну.

3. Риск: архитектурные правила не будут соблюдаться после рефакторинга.
- Мера: формализованные ADR + CI-гейты, блокирующие PR.

## 9) Операционные Правила Для Реализации

1. Миграция только вертикальными срезами (домен целиком), не горизонтально по типам файлов.
2. После каждого батча, влияющего на экспорты/импорты в `stylist-svelte/src/lib/**`:
- `python -u "d:\2026\code\template\stylist\indexation\cli.py"`
3. После каждого батча проверка диагностики:
- `python -u "d:\2026\code\template\stylist\errors\npx\analyzer.py"`
- `python -u "d:\2026\code\template\stylist\errors\yarn\analyzer.py"`
4. Не редактировать вручную сгенерированные `index.ts`.

## 10) Рекомендуемый Следующий Архитектурный Шаг

Подготовить `ADR-001` и `ADR-002` до любых новых переносов файлов. 
Без этих двух решений следующая фаза рискует снова привести к хаотичной структуре.
